name: Generate README Assets

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch:
  push:
    branches: ["master", "main"]

permissions:
  contents: write # Needed to commit generated files

jobs:
  generate-snake:
    name: Generate Snake Contribution Graph
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Snake SVG
        uses: Platane/snk@v3
        with:
          github_user_name: OskaraOskar
          outputs: |
            dist/github-contribution-grid-snake.svg

      - name: Deploy Snake SVG to Output Branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          commit_message: "Deploy snake contribution graph"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-metrics:
    name: Generate GitHub Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Classic Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: Europe/Stockholm

          plugin_introduction: yes
          plugin_introduction_title: yes

          plugin_activity: yes
          plugin_activity_limit: 5
          plugin_activity_days: 14
          plugin_activity_visibility: all
          plugin_activity_timestamps: yes

          plugin_calendar: yes
          plugin_calendar_limit: 1

          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year

          # Adjusted skyline plugin to avoid rendering errors
          plugin_skyline: yes
          plugin_skyline_year: current-year
          plugin_skyline_frames: 24
          plugin_skyline_quality: 0.3
          plugin_skyline_compatibility: yes

      - name: Generate Repository Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: repository
          filename: metrics.repository.svg
          query: |
            {
              "repository": "OskaraOskar"
            }

      - name: Generate Terminal Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: terminal
          filename: metrics.terminal.svg

      - name: Deploy Metrics to Output Branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: .
          commit_message: "Update GitHub metrics"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
