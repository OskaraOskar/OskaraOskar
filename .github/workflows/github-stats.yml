name: Generate README Assets

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: ["master", "main"]

permissions:
  contents: write

jobs:
  # 1. Generate Snake SVG and publish to output branch
  generate-snake:
    name: Generate Snake
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Generate snake.svg
        uses: Platane/snk/svg-only@v2
        with:
          github_user_name: OskaraOskar
          outputs: dist/github-contribution-grid-snake.svg

      - name: Push snake.svg to the output branch
        uses: crazy-max/ghaction-github-pages@v2.6.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Generate GitHub Metrics using lowlighter/metrics
  generate-metrics:
    name: Generate GitHub Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Core, Base & Profile Plugins
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: Europe/Stockholm

          # Introduction plugin
          plugin_introduction: yes
          plugin_introduction_title: yes

          # Activity plugin
          plugin_activity: yes
          plugin_activity_limit: 5
          plugin_activity_days: 14
          plugin_activity_visibility: all
          plugin_activity_timestamps: yes

          # Calendar plugin
          plugin_calendar: yes
          plugin_calendar_limit: 1

          # Isocalendar plugin
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year

          # Skyline plugin
          plugin_skyline: yes
          plugin_skyline_year: current-year
          plugin_skyline_frames: 60
          plugin_skyline_quality: 0.5
          plugin_skyline_compatibility: yes

          # Achievements plugin
          plugin_achievements: yes
          plugin_achievements_threshold: A
          plugin_achievements_secrets: yes
          plugin_achievements_display: detailed
          plugin_achievements_limit: 0

      - name: Repository Template Plugin
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: repository
          filename: metrics.repository.svg
          query: |
            {
              "repository": "OskaraOskar"
            }

      - name: Terminal Template Plugin
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: OskaraOskar
          template: terminal
          filename: metrics.terminal.svg

      - name: Push metrics to the output branch
        uses: crazy-max/ghaction-github-pages@v2.6.0
        with:
          target_branch: output
          build_dir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
